#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>

typedef int8_t  s8;
typedef int16_t s16;
typedef int32_t s32;
typedef int64_t s64;

typedef uint8_t  u8;
typedef uint16_t u16;
typedef uint32_t u32;
typedef uint64_t u64;

typedef s64 sint;
typedef u64 uint;

typedef u8 bool;
#define true 1
#define false 0

u8* ExampleInput = ">>><<><>><<<>><>>><<<>>><<<><<<>><>><<>>";
u8* Input = ">>>><<<<>>>><>>>><<<>><<<>>><<><<>>><<>>><<<>>>><>><<<<><<<>>><<><<>><>>>><<><<>><<<<>>>><<<<>><><>><<>>><<<>><<<><<<>><<<<><<><>>><>><<<><><<<<>>>><<<>>>><<>><<<<><<<<><<<<>>><>>><>>><>>>><<<>>><>>><<<>><<<>>>><<<>>><<>><<<<>>>><<<>>>><<>>>><<>>>><<>><<<>><>>>><<><<<<>>><>><>><<><<<>>>><<<><>><<<<>><>>>><<>>>><<<><>>><<<<>><<><>>>><<>>>><<<>><<<>>><<><>>><<<>>>><<>>>><><<<<>><>>>><<<<><><<<>>>><>>>><<<><<<><<<<><<>><>><><<<>>>><<<<><<<<><<<<>>>><<<<><<>>><<<><<<>>>><<<>><>>>><<<>>>><><>>><<>>><<<>><>>>><<>>>><>>>><<<<>>>><<<<>>><<<<>>><<<<>>>><<<>>>><<><<>>>><<<>><<<<>>>><<><<<><>>>><<<<><>><<<>>>><<<<><<<><<>>><<<>>>><>>><<<<>>>><<<>>><<>>>><<<<>><<<>>><<<<>>><<><<>><<><<<<>><<><<>>><<>>><<>>>><>><>>><<<<>>><<<>>>><<<><<<<>><<<<>>>><<<>><<<<><<<<>>><<<<>>><<><<>><<<>>><<<<>>><>>>><<><<>>><<<>>><<>>><<<>><<<>><<<>>><<<<>>>><<><<>>><<><<<>>>><<<<>>>><>>>><<<><><>><<<>>><<>><<<><<>>>><>><<<<>>>><<<><<>><><<<<>>><<>>><>><>><<<<>>>><<>>>><<<<>>>><<<<>>>><>><<>>><<>><<><>>><<<<><><<>>><>>>><<<<><<>>>><<<><>><<>>><<<><<>><><<<<>>><>>>><>>>><<<>>>><<>>>><<<><><>><<>>>><<<>>><<<>>>><<><<>><<<<>><<<>>><<<<>><>>>><<>>><>>>><<>>><<<<>>><>>>><>><<<<><<<>>><<<<>><<<<>><<>>><<<>><>>>><>>><<<<>><>><<<><<<>><<>>><>>>><<><<<<>><<<<>><>>><<<<><<<>>><<<>>><<<<>><<<>>><>>>><<<<>>>><<>>>><<><<>>>><<<<>>><<<<>>><<>>><<><<<<>>>><<>><<<>><>><>><<><<><<<><<<<>><<>>><<<<>><<<><<<<><><<><<<<>>><><<<<>><<<>><>>>><<><<<>>>><<<><<<><>>>><<>>><<<<><>>><<<<>><<<<>><<<>>><<<<>><>><<<<><>>><<<>><>><<>>>><<>>>><<<<><<<><<>>>><<<<>><<<<><<<<>>>><<<<>>><<<<>><<<>><<>>><<<<>><<<<>><<>>><<>>>><<<<>>>><<<>>><<>><<<<>>><>><<>><><<>><<<<>>><<<<><>>><<>>><>>><<><<<>>><<<<>>><<<<>><<><<<<>><>>>><>>>><<<<>><>><<<<>>>><<>>>><<><<>>>><<>>><<<><<<>>><<<>>><<<<><<><<<<>><<<>><<<<>>>><<<>>>><<>>><>>>><>>>><<<<>>>><<<>>>><<><<<<>>>><<>><<<<><<<>><<>>>><<<>><>>><>><>>>><<>>><><>><>><<>>><>><<<>>>><<<>><>>><<<>><<<>>><<>><<<<><<><>><>>><<>><>><<>>><>><<<>>>><<>><>><<<<><<<<>><<>><<<><<<<>>><>>><<<<><<>>>><<>><<<<><<>><<<>>>><<<>>><<>>><<<>>>><<><<<>><<>><><<<<>>>><<<<>><<>>><<><<<>>><<>>>><<<>>><<<>>><<>>><<<<>>><<<>>>><<<<>>><<<>>>><><>><>><<<><>><<>>>><<<>><<<<>>><<<><>>><<<<>>><<<<><<<>>>><<<>><<<<>><<<<><<>>><<<<>>><<<>><<><<<><<>>><>>>><>><<<<>><<<<><<<<>><<<<>>><<<>>><<>><<>>><<<><<<><<>>><<>>><<>>>><>>>><>>><<<<>>><<<<>>><<>>><<><<>>>><>><<>>>><>><>>>><<<><>><<>>><>>>><<<>>>><<>><>>>><>>><<><>><>><<>>>><<<>>>><>>><<<<>>><<>>><>>><<<>>>><<<<>>>><<>>><>><<<<><><<>>><<<>>><<>>><<<><>><<>>><<><>>><<>><<><>>><>>><<<><<<<><<<<>><><><<<<>>><<<>>>><<<<>>><<>>><>>><<><>>><>><>><<<<>><<<>><<<<>>>><<>>>><<<<>>><>>>><<<>>><>>>><<<<><<<<>>><><<<<>>><<><<>><<<>>><<><<<<><<<><>>>><>>><><<<>>>><<<<>>><<<<><<>>>><<><<>>><>><<<>>><<<>>><<<<>>>><<>>>><><><<<<>>><><<<><>>><<>><<<>><>>>><<<<>>>><<<><<><<><<<<>><<>>><><<>><<<>>>><<<<>>>><<<>>>><<<>><<<>>><<>><><>>><<<><<<>>>><<<<><>>><>>>><<<<>>><<<>>><<<>>><<>><>><<<>>><><>><<<<>>><<<>>>><<<>>><<<>><<<<>><<<<>>>><<<<>>>><<<>>>><<<<>>><<<<>>>><<<>>><<<>><<<>><>>>><<>><>><<<<>><<<<><><<<><<<<>>><>><<<>>><><<><>><<<>><<<<>><<<<>><>>>><<<><<<<>>><<<>>><<<<><<<>>>><<<<>>>><<>>>><<<>><<<<><>><<>>><<<><<<<>><<>><<<>>>><<>>>><<<><>>><>><<>>><<>>>><<>><<<<>>>><<<>>><<>>><<<<>><><<>>><<<<>>><<>><<<><<<<>><<<<>><<<><<>><<>>><<>><>>>><<<>><<<>>><<<>>><<<><><<><<<<>>>><<>>>><<<<><><<>>><<>><>>><>>>><>><>>><<<<>>><>><>>><<<<><<<><>>>><>>>><<<><<>>>><<<><<<<><<<>>>><<<<><<<>><<>><<<>>><>><<<><<<><<<>>>><<>><<<<><>><><>>>><<>>><><<<>>>><<>>><<<<><<<>>><<<<><<<<>><>>>><<>>><<>>>><<<>>><>><>>><<><><<>>><<<>>><<<>>>><<<>>><<<<>>><<<<><<<<>>>><<<<><>>><<<<>>>><<>><>>><<<><<>><>>>><<<<>>>><><<>><<<>>><>>>><>><<<<>>>><>><<<<>>><<<><<<>><<<><>>><<><<<>>><<<><<<<>>>><<<<>>><>>><><<><>><<>>><<><<<<>><>>>><<<<><>>><<>>>><<<<>><<>><<<><<<<>><<>>>><<>><<<<><<<<>><<<<>>>><<>>><<<<><><<<>>>><<<><<<<><>>><<>><<<<>>><<<<>>>><<<<>>>><<<>>>><><<<<>>>><><<<<>>><<<>>>><<<<>>><<>>>><<<<>>><>><><<<<>>>><<<<>>>><<><<>>><<<>><><<<>>>><<<<>><>>>><<<><<>>><<><<><>>><<>>>><<<>>><<<>>>><>>>><<<<>>>><<>><<>>>><<<>>><<<><<<><<>>><>>>><<>>>><><>><<<><<>><<>>>><>><<<>><<<<>>>><>><>>><<<>>><<<>><<>>>><<<>><><<<><>><<<>>>><<<<>>>><<>>><<>>><>>><><<<>><<<>><<<><<<<>><<>><<<>>>><<<>>>><<<>>><<>>>><<<>>><<<>><<>>><<<>>>><<<>>><><<<<>>><<<>><>>><><<<>>>><><<<>>><<<<>>><<>>>><<>>><<><<<<>><<<<><<>>>><<>>><><<<<><>>><<<<>><<<>><><<<><>>>><<<<>>><><<>>>><<>>><<<>><>>>><>>><<<><<><>><<<>>><>>><<<<>>>><>>><<<>>>><<<>>>><><<<><<<<>><<>>>><<<>><<<>>>><<>>><<<>>><<<<>><<<>>>><>>><<<>><<<<><<<>>>><<><<><<<<>>>><>>><>>><<<>>><>><<><<<<>><<>>>><<<<>>>><<<><<<>><<><<><<>>>><><<>>>><<<>>>><<><<<<>><<>><<<>>>><<>>><<<<>>><<<<>><<><<<>>><<<>><<<<>><<<<>>>><<>>><<<<>>><<>>>><>>><<>><<<><>>>><<>>><<><<>>><<<>>>><<>>>><<<<><<>><<<<>>><<<><<<>><<<<>><<<>><>>>><>>><<>>>><>>>><<<><<>>><<<<>>>><<<>><<<>>>><<><<<>>><<>>><<<>><<>>><>>>><<><<<>><<>>><<>>>><<>><<<<>><>>><>>><>>><<>>><<>>><<<<><<<<>>><<<<><<>>><<<>>><<<<>>>><<<>>><>>><<>>><>><<<<>>>><<<>><<<>>>><><<>><>>><>><>><<>>>><<<<>>><<<<>><<><<>>>><<>><<><<<>>>><<<><<<<>>>><<>>>><>><<>>>><<<>>><>>><<>>>><<>>>><<<<>>><>><<<>>>><<<<>><<>>><>>><<<<>>>><>>>><<<<><<<>>><>>>><>>><<>><<<<>><>><<<><<<<><<>>><<<<>>>><<<<>><>>>><<<>><<<<><<><<>>>><<<<>>><<><<<>>>><<<><>>><<<>>>><<>><<<><><<<><<>>>><>><<<>><<<>>>><<<<><>><<>><<<>>>><<><>>><>>>><<<>><<<>><<<>><><>>><<><<>>>><>>>><><<<>>>><<<>>><>>><<<<>>><<<>>><<>><<><<>><<<<><<<<>>><>>><<>>>><<<<>>><>>>><<<>>>><<<>>><<<<>>><<<>>>><<<>><>><<<<>>><<<>>><<<>>><<<>>>><<<<>>>><<<<>>><<<>>><<<><<<<>>><<>>><<>>>><<<>>><><<<>>><<<>>><<<>><>>>><<<>><<<>><<<<>>><<<<>><>><>>>><>>><<<<><<<>>><<<>>><<>><<<>>>><<<><<>>>><<<<><<>>><<<>>>><<<<>>><><<<<><<>>>><>>>><<>>><><>><>>>><<<<>>><<<<>><<<<><>>><<><<<<><>>>><>>><<><>>><<<>>>><<<<><<<<>>><<<<><<<<>>><<<<>>><<<<>>>><><<<<>>><<<><<<>>>><<<<>>>><<>><<<>><<<><<>>><<>><<><<><<<<>>>><<<<>>><<<<><<<<><<>>><<<<><<<<>>><>><<<>>><<<<>>><<<<><>>>><<<>><<<<><<<><>>>><>>><<<>><>>><<>>>><<>>><<<<>>>><<<<>>><<>><<>>><<<>><<<<><<>><<<>>><<<>><<<>><<><><<<<>>><<>><<><>>>><<<<>>>><<<>>><<<><<>>>><<<>>><<>><>>><<>><<<<>>>><>>><>>>><<<>>>><><>>><<<>><<<<>>>><<<<>><<>>><<<<><<>>>><<<<>><<<<><<><<>>>><<<>>><<<<>>>><<<<><>>>><<<<>><<>><>><<<>><<<<>>><<<>>><>>><>>>><<<>>>><<<<><<<<>>>><<<>>>><<<>>>><<>>><>>><<<>>><<>>>><<<<>>><>>><<>><<<>>>><<<><<>>><<<<>>><<<<>><<<><<<>><<<<>>><<<><<<<>>>><>>>><<>><<<<>>><><<<<>><<<<>><<<>>>><><>>><>>>><<<<>><<<>>><>>><<<>>>><<<>><<<<>>><<><<><<<<>>><>>>><<<>><>><<<<>>>><<<><<<<>>><<<><<>>>><<<<>>><<<<>>>><<<<>>>><><<>>><<>>>><<>>>><<>>>><<<<>><<<>>><>>><<<<><<>><<<><<<>>><>>>><<<>><>><<<>><<>>><<<<>><>><<<<>>><<>>><<<<>>><<<<>><<<>><><<<>><<<<>>>><<<<>>>><<<>>>><<>>>><<<<>>>><<<>>><<>><<<>><<>><<>>>><<<<>>><><<<>>>><<>><>><<<<><>><>>>><<><<<<>><<<<>><>>>><<<>><<<>>>><<<<>>><<<>>><<<<>><<<><<>><<<>>>><<<<><<<>><<<>>>><>><<>><>>>><<>>>><<<<>>><>>>><<>>>><<>><<<>><>><<<<>>>><<<<>>>><<<<>><<<<>>><<<>>><<<>>><<<>>>><<<><>>>><><<<><>><<<<>><>>><<>>><>>>><<<<>>>><<<><>>>><<<>><<<<>>><<><<<<>><<<>><>><<<>><>>>><<<>>><<>><<<>><>><<<><<<<>>>><>>><><<<<>>>><<>><>>><<<><<<>><<<<>>>><<<<>>><<<<>>>><<<<>>>><><>>>><<<<>>><><<<><<<<>><<<<>>>><<<<>><<<<>>><>>>><<<><<<<>><<>><<><><<>>>><<<<><><<>>><>>><<<<>>><<>>>><<><<>><<<<>>>><>>>><<<><<>>>><<<>><<<>>>><>><<>>>><<>>>><<<>>>><>>>><<>>><<>>>><><><<<>><<><><<<<>>><>>>><<><<>>><<<>>><<<>>>><<<>>>><<><>><<>><>>>><<<><<><<<<>>><<<>>>><<<<><<>>>><<<<>>>><<<><<<><<<><>>><<>><>>>><>>><<<>>>><<<>>>><>>><<<><<<<>>>><<>>>><><>>>><<<<><<>>><<<>>><>>>><>><<<>>><<><<>><<<<>>>><<>><<><>><<<>><><<<<><<<>><<<<><>>><<<<>>>><<<><<<<><<<>>><<<>>>><<<>>><<>>>><<<<>>>><<<>><<>>><<<<>>><<<<>><<><>><<>>><>>><<>><<>>>><<>>>><<>>><<<>>><><<>><<<>><<<><<>>>><<><<<>>>><>><<<>>>><<<>>>><<>>><<<<>>>><<>>><<<>>><<<<><<>>>><><>>>><<>>>><<<>>>><<<><<<<>>><<<<>><<><<<>><>>><<>>><<<>>>><<>>>><<<<>>>><<<<>>>><<<<>><<<>>>><<<>>>><<<>><<>>>><<<<><<<<>><<<>>>><<>>><<<<><<>>><<>>>><<<><>>><<<>>><>>><<><<<><<>>><<><>>>><<>>>><<><<><<<><<<>>><<<<>>><<><<<>><<<<><<<<>>>><<<>>><><<<<>><<<<>>>><<<>><<>>>><<<>>><>>><>><<><<>>><<><>><<>>><><<<<>>><<<>>><>>><<<<>><<<<><><<<>>>><>>><><<<>>><<<>>><<><<<>>>><>>>><<<>>>><>>>><<<<>>>><<<>><<<>>><<>><<<>>>><<<<><>><<<>>><<>><<<<>>>><<><><<<>><><><>>>><<<>>><<<>>><<<<>>>><<<<><<><<<<>><<<<>>>><<<<>>><>><<>><>>><<>><<><<>>>><<>><<>><<>><>>>><>><<<<>><<><<<<>>><<<>><<<>>>><<<>>>><<<>><>>><<<>>><>>>><<<<><>><<>>>><>>>><<<>>>><<<<>>><<<>>><>>>><<>>><<<>>>><<>><<<<>>>><>>>><<<>><<<<><<<><<<>>><<<>>>><<<><<<>>><<<<>>>><<><<>><<>><<<<>><>>><<<<><><<>>>><<<<>>><<<<>>>><>>><<<<>>>><<>><>>><<<<>>>><<<><<<><<<<>>>><>>>><<<<>>>><<<<>><<<>><<>>>><>>>><<>>>><<><<<><<><>><<<>>><<><<>><<<<>><<<>>>><<<>>>><<>>>><<>>><<>><<<<>><>>>><>><<<<>>>><<>>><>>><<<>>><<<<>>><<<<>>>><<<>>><<<>><<<<>>>><<<>>><<<<><<><<><<<>><<<<><>>>><<<>><>>>><<<><<<<>><<<><<>>><<<<>>>><<<><<<>><>><>>>><<>><<<<><<<>><<>>><<>>>><<>>><>>>><<<<>>>><<><<<<><<>><<>><>><<<<><>>><<>>>><<><<>>>><><<<><>>><<<><<<<><<<>>>><<<<>>>><<<<>><<<<>>>><<<<><<>><<<>><>><<<<>><><<<<>>><><<<>>>><<>><<<<>><<<>>><><<<>>>><<<<>>>><>>><<<>><<<>>><<<<>>><<>>>><>>><>>>><<<><<<>>><<<>>>><<<<>>>><<><<<<>>><<<>>>><>>><>><<<>>>><>>>><<><>><<<<><<><<<<><<<>>>><>>><>><>>>><<<>>><<<>><<<<><<>>><<<<>>>><<<>>>><><<<<>>><<<<>>><<><<<<>><><<<>><<>><<<<>>><<<>>>><>><<>>>><>><>>><<<>><<<><<<><<<>><>>><<><<>>>><<<>>><>>>><<><<<<>><<<<><<<<>><<>><>>>><><<>>>><>><>><<<<>><>>>><<<<>><<<>>><<>><<<>>>><<<><<<>><>><<<<><<><<>>><<<<>><<<<>><<<<>>>><<<<>>>><<<<>>>><<>>>><<>>>><<>>><<<<><<<<>>><>><><<>><<>><<<<>>><<<><<>>>><<<>><<>>><<<<><<<<>>><<<>><<<<>>>><<<<>><<>>>><<<<>>>><<>>>><<>>>><>>>><<>><>>><<<<>>><<><<>><<<>>>><<<>><<<<>><<<>><<<<>>>><<<<>>><<<<>>>><<<<>>>><<<>><<>><<>><<<>>><<<>>>><><>>>><<<<>>><>><<<<>><<<>><<<<>><>><<<<>>>><>><<>>><<<>>>><<<>><<<<>>><<<<>>>><<<>>><<<<>>><<<<>>><<>>><<<<><<>>>><>><>>><<<><<<><<<<>>>><<>><<<><<<<>><<>>>><<>><<<<>>><<<<>><<>><<>>><>>><<><<<><<<>>>><><<<>><<>><><<<>><<<<>>><<<>><<<<>><<>>>><>><<<>>>><><<<<>>>><<<<>>>><<<>>>><<<<><<<>>><<>><<>>><<>><<<>>><<<>>><<><<<>>>><<<<>><<<>><<<><<>>>><>>>><<<><<>>>><>><<<<>>>><>>>><>><>>>><<<<>><<<>><<>>>><<<<>>><<<<>><<<<>>>>";

typedef struct Stone
{
	union {
		u8 pattern_bytes[4];
		u32 pattern;
	};
	u8 width;
	u8 height;
	u8 peaks[4];
	u8 max_peak_idx;
} Stone;

Stone Stones[] = {
	{
		.pattern      = 0x0000001E,
		.width        = 4,
		.height       = 1,
		.peaks        = {1, 1, 1, 1},
		.max_peak_idx = 0,
	},
	{
		.pattern      = 0x00081C08,
		.width        = 3,
		.height       = 3,
		.peaks        = {2, 3, 2, 0},
		.max_peak_idx = 1,
	},
	{
		.pattern      = 0x0004041C,
		.width        = 3,
		.height       = 3,
		.peaks        = {1, 1, 3, 0},
		.max_peak_idx = 2,
	},
	{
		.pattern      = 0x10101010,
		.width        = 1,
		.height       = 4,
		.peaks        = {4, 0, 0, 0},
		.max_peak_idx = 0,
	},
	{
		.pattern      = 0x00001818,
		.width        = 2,
		.height       = 2,
		.peaks        = {2, 2, 0, 0},
		.max_peak_idx = 0,
	},
};

int
main(int argc, char** argv)
{
	u8* flow      = Input;
	uint flow_len = strlen(flow);

	typedef struct Cache_Entry { u8 p; u8 stone_x; u8 stone_y; u16 flow_cursor; uint floor[7]; } Cache_Entry;
	uint cache_cap = 10000;
	uint cache_size = 0;
	Cache_Entry* cache = malloc(sizeof(Cache_Entry)*cache_cap);

	uint chamber_size       = 1000;
	u8* chamber             = calloc(chamber_size, sizeof(u8));
	uint chamber_base       = 0;
	uint chamber_width      = 7;
	uint pile_floor[7]      = {0};
	uint pile_floor_min_idx = 0;
	uint pile_floor_max_idx = 0;

	uint flow_cursor = 0;
	for (uint i = 0; i < 1000000000000; ++i)
	{
		//if (i % 10000000 == 0) printf("%llu\n", i), fflush(stdout);
		//if (i == 2022) printf("Part 1: %llu\n", pile_floor[pile_floor_max_idx]);
		//if (i == 28 || i == 168 || i == 308 || i == 28+92) printf("[%llu] %llu\n", i, pile_floor[pile_floor_max_idx]), fflush(stdout);
		if (i == 176 || i == 7156 || i == 14146 || i == 176+4324) printf("[%llu] %llu\n", i, pile_floor[pile_floor_max_idx]), fflush(stdout);

		Stone stone = Stones[i%(sizeof(Stones)/sizeof(0[Stones]))];
		uint stone_y = (pile_floor[pile_floor_max_idx] - pile_floor[pile_floor_min_idx]) + 3;
		uint stone_x = 2;

		for (uint j = 0; j < 4; ++j) chamber[(chamber_base + stone_y + j)%chamber_size] = 0;

		if (stone_y + stone.height > chamber_size) __debugbreak(), *(volatile int*)0 = 0;

		// TODO: do 3 steps in one go

		for (;;)
		{
			u32 chamber_slice = chamber[(chamber_base + stone_y + 0) % chamber_size]        |
				            ((u32)chamber[(chamber_base + stone_y + 1) % chamber_size] << 8)  |
				            ((u32)chamber[(chamber_base + stone_y + 2) % chamber_size] << 16) |
				            ((u32)chamber[(chamber_base + stone_y + 3) % chamber_size] << 24);

			if      (flow[flow_cursor] == '>' && stone_x + stone.width < chamber_width && ((stone.pattern >> 1)&chamber_slice) == 0) stone_x += 1, stone.pattern >>= 1;
			else if (flow[flow_cursor] == '<' && stone_x > 0 && ((stone.pattern << 1)&chamber_slice) == 0)                           stone_x -= 1, stone.pattern <<= 1;
			else if (flow[flow_cursor] == 0) __debugbreak(), *(volatile int*)0 = 0;
			flow_cursor = (flow_cursor+1)%flow_len;

			u32 dropped_chamber_slice = chamber[(chamber_size + chamber_base + stone_y - 1) % chamber_size] | (chamber_slice << 8);
			if (stone_y == 0 || (dropped_chamber_slice & stone.pattern) != 0)
			{
				/*
				if (cache_size < cache_cap)
				{
					cache[cache_size++] = (Cache_Entry){ .p = i%4, .stone_x = stone_x, .stone_y = stone_y, .flow_cursor = (u16)flow_cursor, .floor = { pile_floor[0], pile_floor[1], pile_floor[2], pile_floor[3], pile_floor[4], pile_floor[5], pile_floor[6]}};
				}
				else goto end;*/

				uint old_pile_floor_min = pile_floor[pile_floor_min_idx];

				/// Add stone to stone pile
				for (uint j = 0; j < 4; ++j)
				{
					chamber[(chamber_base + stone_y + j) % chamber_size] |= stone.pattern_bytes[j];
				}

				/// If added stone protrudes above pile floor update pile floor to the new height
				for (uint j = 0; j < stone.width; ++j)
				{
					if (pile_floor[stone_x+j] < old_pile_floor_min + stone_y + stone.peaks[j])
					{
						pile_floor[stone_x+j] = old_pile_floor_min + stone_y + stone.peaks[j];
					}
				}

				/// Update max floor
				if (pile_floor[stone_x+stone.max_peak_idx] > pile_floor[pile_floor_max_idx]) pile_floor_max_idx = stone_x + stone.max_peak_idx;
				
				/// If the min floor column has changed update min and raise floor
				if (pile_floor[pile_floor_min_idx] != old_pile_floor_min)
				{
					pile_floor_min_idx = 0;
					for (uint j = 0; j < 7; ++j)
					{
						if (pile_floor[j] < pile_floor[pile_floor_min_idx])
						{
							pile_floor_min_idx = j;
						}
					}

					chamber_base = (chamber_base + (pile_floor[pile_floor_min_idx] - old_pile_floor_min)) % chamber_size;
				}

				break;
			}
			else stone_y -= 1;
		}
	}

	printf("Part 2: %llu\n", pile_floor[pile_floor_max_idx]);
/*
	end:;
	for (uint i = 0; i < cache_cap; ++i)
	{
		for (uint j = i+1; j < cache_cap; ++j)
		{
			if (cache[i].p == cache[j].p && cache[i].stone_x == cache[j].stone_x && cache[i].stone_y == cache[j].stone_y && cache[i].flow_cursor == cache[j].flow_cursor && memcmp(cache[i].floor, cache[j].floor, sizeof(uint)*7))
			{
				printf("p: %u, x: %u, c: %u at %llu to %llu\n", cache[i].p, cache[i].stone_x, cache[i].flow_cursor, i, j);
				break;
			}
		}
	}*/

	return 0;
}
